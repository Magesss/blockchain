<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒºå—é“¾æµè§ˆå™¨ - é’±åŒ…è½¬è´¦</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .nav {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        .nav a:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .nav a.active {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .transfer-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .transfer-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .address-input {
            font-family: monospace;
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .balance-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .balance-item:last-child {
            margin-bottom: 0;
        }

        .balance-label {
            font-weight: bold;
            color: #495057;
        }

        .balance-value {
            color: #28a745;
            font-weight: bold;
        }

        .transaction-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .transaction-result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .transaction-result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .transaction-details {
            margin-top: 10px;
            font-family: monospace;
            font-size: 14px;
        }

        .quick-select {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .quick-select button {
            padding: 6px 12px;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .quick-select button:hover {
            background: #667eea;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .wallet-list {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .wallet-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .wallet-info {
            flex: 1;
        }

        .wallet-name {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .wallet-address {
            font-family: monospace;
            font-size: 12px;
            color: #6c757d;
        }

        .wallet-balance {
            text-align: right;
            font-weight: bold;
            color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”— åŒºå—é“¾æµè§ˆå™¨</h1>
            <p>é’±åŒ…è½¬è´¦</p>
        </div>

        <div class="nav">
            <a href="/">é¦–é¡µ</a>
            <a href="/blocks">åŒºå—</a>
            <a href="/transactions">äº¤æ˜“</a>
            <a href="/tokens">ä»£å¸</a>
            <a href="/transaction-visualizer">äº¤æ˜“å¯è§†åŒ–</a>
            <a href="/transfer" class="active">è½¬è´¦</a>
        </div>

        <div class="transfer-container">
            <h2>ğŸ’¸ é’±åŒ…è½¬è´¦</h2>

            <div class="transfer-form">
                <div class="form-group">
                    <label for="transfer-type">è½¬è´¦ç±»å‹:</label>
                    <select id="transfer-type">
                        <option value="coins">ä¸»å¸è½¬è´¦ (Coins)</option>
                        <option value="tokens">ä»£å¸è½¬è´¦ (Tokens)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="from-wallet">å‘é€æ–¹é’±åŒ…:</label>
                    <select id="from-wallet">
                        <option value="">è¯·é€‰æ‹©å‘é€æ–¹é’±åŒ…</option>
                    </select>
                </div>

                <div class="balance-info" id="balance-info" style="display: none;">
                    <div class="balance-item">
                        <span class="balance-label">å¯ç”¨ä½™é¢:</span>
                        <span class="balance-value" id="available-balance">0 coins</span>
                    </div>
                    <div class="balance-item">
                        <span class="balance-label">é¢„è®¡æ‰‹ç»­è´¹:</span>
                        <span class="balance-value" id="estimated-fee">0.001 coins</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="to-address">æ¥æ”¶æ–¹åœ°å€:</label>
                    <input type="text" id="to-address" class="address-input" placeholder="è¾“å…¥æ¥æ”¶æ–¹é’±åŒ…åœ°å€">
                    <div class="quick-select">
                        <button type="button" onclick="selectQuickAddress('alice')">Alice</button>
                        <button type="button" onclick="selectQuickAddress('bob')">Bob</button>
                        <button type="button" onclick="selectQuickAddress('charlie')">Charlie</button>
                    </div>
                </div>

                <div class="form-group" id="token-select-group" style="display: none;">
                    <label for="token-select">é€‰æ‹©ä»£å¸:</label>
                    <select id="token-select">
                        <option value="">è¯·é€‰æ‹©ä»£å¸</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="amount">è½¬è´¦é‡‘é¢:</label>
                    <input type="number" id="amount" step="0.01" min="0.01" placeholder="è¾“å…¥è½¬è´¦é‡‘é¢">
                    <div class="quick-select">
                        <button type="button" onclick="setQuickAmount(10)">10</button>
                        <button type="button" onclick="setQuickAmount(50)">50</button>
                        <button type="button" onclick="setQuickAmount(100)">100</button>
                        <button type="button" onclick="setMaxAmount()">æœ€å¤§</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="custom-fee">æ‰‹ç»­è´¹ (Gas):</label>
                    <input type="number" id="custom-fee" step="0.001" min="0.001" placeholder="è‡ªå®šä¹‰æ‰‹ç»­è´¹ï¼Œç•™ç©ºä½¿ç”¨å»ºè®®å€¼">
                    <div class="quick-select">
                        <button type="button" onclick="setQuickFee('auto')">è‡ªåŠ¨</button>
                        <button type="button" onclick="setQuickFee(0.001)">ä½ (0.001)</button>
                        <button type="button" onclick="setQuickFee(0.01)">ä¸­ (0.01)</button>
                        <button type="button" onclick="setQuickFee(0.1)">é«˜ (0.1)</button>
                    </div>
                </div>

                <div class="form-group">
                    <button type="button" class="btn btn-primary" onclick="sendTransfer()">å‘é€è½¬è´¦</button>
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">æ¸…ç©ºè¡¨å•</button>
                </div>

                <div class="transaction-result" id="transaction-result">
                    <div id="result-message"></div>
                    <div class="transaction-details" id="transaction-details"></div>
                </div>
            </div>
        </div>

        <div class="wallet-list">
            <h3>ğŸ’° é’±åŒ…åˆ—è¡¨</h3>
            <div id="wallet-list-content">
                <div class="loading">æ­£åœ¨åŠ è½½é’±åŒ…ä¿¡æ¯...</div>
            </div>
        </div>
    </div>

    <script>
        let wallets = [];
        let selectedWallet = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadWallets();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('transfer-type').addEventListener('change', onTransferTypeChange);
            document.getElementById('from-wallet').addEventListener('change', onWalletChange);
            document.getElementById('amount').addEventListener('input', updateEstimatedFee);
            document.getElementById('custom-fee').addEventListener('input', updateEstimatedFee);
            document.getElementById('token-select').addEventListener('change', onTokenChange);
        }

        async function loadWallets() {
            try {
                // åŠ è½½é’±åŒ…åˆ—è¡¨ - è¿™é‡Œéœ€è¦ä¸€ä¸ªAPIç«¯ç‚¹æ¥è·å–é’±åŒ…ä¿¡æ¯
                const response = await fetch('/api/wallets');
                if (response.ok) {
                    const data = await response.json();
                    wallets = data.wallets || [];
                } else {
                    // å¦‚æœæ²¡æœ‰APIï¼Œä½¿ç”¨é»˜è®¤é’±åŒ…
                    wallets = [
                        { name: 'alice', address: 'alice_address_placeholder' },
                        { name: 'bob', address: 'bob_address_placeholder' },
                        { name: 'charlie', address: 'charlie_address_placeholder' }
                    ];
                }

                updateWalletSelect();
                updateWalletList();

            } catch (error) {
                console.error('åŠ è½½é’±åŒ…å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤é’±åŒ…
                wallets = [
                    { name: 'alice', address: 'alice_address_placeholder' },
                    { name: 'bob', address: 'bob_address_placeholder' },
                    { name: 'charlie', address: 'charlie_address_placeholder' }
                ];
                updateWalletSelect();
                updateWalletList();
            }
        }

        function updateWalletSelect() {
            const select = document.getElementById('from-wallet');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©å‘é€æ–¹é’±åŒ…</option>';

            wallets.forEach(wallet => {
                const option = document.createElement('option');
                option.value = wallet.name;
                option.textContent = `${wallet.name} (${wallet.address.substring(0, 10)}...)`;
                select.appendChild(option);
            });
        }

        async function updateWalletList() {
            const container = document.getElementById('wallet-list-content');

            if (wallets.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— é’±åŒ…æ•°æ®</div>';
                return;
            }

            // è·å–æ¯ä¸ªé’±åŒ…çš„ä½™é¢
            const walletItems = await Promise.all(wallets.map(async wallet => {
                let balance = 0;
                try {
                    const response = await fetch(`/api/address/${wallet.address}`);
                    if (response.ok) {
                        const data = await response.json();
                        balance = data.balance || 0;
                    }
                } catch (error) {
                    console.error(`è·å–${wallet.name}ä½™é¢å¤±è´¥:`, error);
                }

                return `
                    <div class="wallet-item">
                        <div class="wallet-info">
                            <div class="wallet-name">${wallet.name}</div>
                            <div class="wallet-address">${wallet.address}</div>
                        </div>
                        <div class="wallet-balance">${balance} coins</div>
                    </div>
                `;
            }));

            container.innerHTML = walletItems.join('');
        }

        function onTransferTypeChange() {
            const transferType = document.getElementById('transfer-type').value;
            const tokenSelectGroup = document.getElementById('token-select-group');

            if (transferType === 'tokens') {
                tokenSelectGroup.style.display = 'block';
                loadTokens();
            } else {
                tokenSelectGroup.style.display = 'none';
            }

            // é‡æ–°æ›´æ–°ä½™é¢æ˜¾ç¤º
            if (selectedWallet) {
                onWalletChange();
            }
        }

        async function loadTokens() {
            try {
                const response = await fetch('/api/tokens');
                if (response.ok) {
                    const data = await response.json();
                    const tokens = data.tokens || [];
                    updateTokenSelect(tokens);
                }
            } catch (error) {
                console.error('åŠ è½½ä»£å¸å¤±è´¥:', error);
            }
        }

        function updateTokenSelect(tokens) {
            const select = document.getElementById('token-select');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©ä»£å¸</option>';

            tokens.forEach(token => {
                const option = document.createElement('option');
                option.value = token.name;
                option.textContent = `${token.name} (${token.symbol})`;
                select.appendChild(option);
            });
        }

        function onTokenChange() {
            // å½“é€‰æ‹©ä»£å¸æ—¶ï¼Œæ›´æ–°ä½™é¢æ˜¾ç¤º
            if (selectedWallet) {
                updateTokenBalance();
            }
        }

        async function updateTokenBalance() {
            const transferType = document.getElementById('transfer-type').value;
            const tokenName = document.getElementById('token-select').value;

            if (transferType === 'tokens' && tokenName && selectedWallet) {
                try {
                    const response = await fetch(`/api/address/${selectedWallet.address}/tokens/${tokenName}`);
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('available-balance').textContent = `${data.balance || 0} ${tokenName}`;
                    }
                } catch (error) {
                    console.error('è·å–ä»£å¸ä½™é¢å¤±è´¥:', error);
                    document.getElementById('available-balance').textContent = `0 ${tokenName}`;
                }
            }
        }

        async function onWalletChange() {
            const select = document.getElementById('from-wallet');
            const walletName = select.value;

            if (!walletName) {
                document.getElementById('balance-info').style.display = 'none';
                selectedWallet = null;
                return;
            }

            selectedWallet = wallets.find(w => w.name === walletName);
            if (!selectedWallet) return;

            const transferType = document.getElementById('transfer-type').value;

            if (transferType === 'tokens') {
                // ä»£å¸è½¬è´¦æ¨¡å¼
                updateTokenBalance();
            } else {
                // ä¸»å¸è½¬è´¦æ¨¡å¼
                try {
                    const response = await fetch(`/api/address/${selectedWallet.address}`);
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('available-balance').textContent = `${data.balance || 0} coins`;
                    }
                } catch (error) {
                    console.error('è·å–ä½™é¢å¤±è´¥:', error);
                }
            }

            document.getElementById('balance-info').style.display = 'block';
        }

        function selectQuickAddress(walletName) {
            const wallet = wallets.find(w => w.name === walletName);
            if (wallet) {
                document.getElementById('to-address').value = wallet.address;
            }
        }

        function setQuickAmount(amount) {
            document.getElementById('amount').value = amount;
            updateEstimatedFee();
        }

        function setMaxAmount() {
            if (!selectedWallet) {
                alert('è¯·å…ˆé€‰æ‹©å‘é€æ–¹é’±åŒ…');
                return;
            }

            const balanceText = document.getElementById('available-balance').textContent;
            const balance = parseFloat(balanceText.replace(' coins', ''));
            const fee = 0.001; // åŸºç¡€æ‰‹ç»­è´¹
            const maxAmount = Math.max(0, balance - fee);

            document.getElementById('amount').value = maxAmount.toFixed(3);
            updateEstimatedFee();
        }

        function updateEstimatedFee() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const customFee = parseFloat(document.getElementById('custom-fee').value);

            let totalFee;
            if (!isNaN(customFee) && customFee > 0) {
                // ä½¿ç”¨è‡ªå®šä¹‰æ‰‹ç»­è´¹
                totalFee = customFee;
            } else {
                // ä½¿ç”¨è‡ªåŠ¨è®¡ç®—çš„æ‰‹ç»­è´¹
                const baseFee = 0.001;
                const amountFee = amount * 0.0001;
                totalFee = Math.max(baseFee, amountFee);
            }

            document.getElementById('estimated-fee').textContent = `${totalFee.toFixed(6)} coins`;
        }

        function setQuickFee(fee) {
            const feeInput = document.getElementById('custom-fee');
            if (fee === 'auto') {
                feeInput.value = '';
            } else {
                feeInput.value = fee;
            }
            updateEstimatedFee();
        }

        async function sendTransfer() {
            const fromWallet = document.getElementById('from-wallet').value;
            const toAddress = document.getElementById('to-address').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const transferType = document.getElementById('transfer-type').value;
            const tokenName = document.getElementById('token-select').value;

            // éªŒè¯è¾“å…¥
            if (!fromWallet) {
                showResult('error', 'è¯·é€‰æ‹©å‘é€æ–¹é’±åŒ…');
                return;
            }

            if (!toAddress) {
                showResult('error', 'è¯·è¾“å…¥æ¥æ”¶æ–¹åœ°å€');
                return;
            }

            if (!amount || amount <= 0) {
                showResult('error', 'è¯·è¾“å…¥æœ‰æ•ˆçš„è½¬è´¦é‡‘é¢');
                return;
            }

            if (transferType === 'tokens' && !tokenName) {
                showResult('error', 'è¯·é€‰æ‹©è¦è½¬è´¦çš„ä»£å¸');
                return;
            }

            // ç¦ç”¨æŒ‰é’®
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'å‘é€ä¸­...';

            try {
                const customFee = parseFloat(document.getElementById('custom-fee').value);
                const requestBody = {
                    from: fromWallet,
                    to: toAddress,
                    amount: amount,
                    type: transferType
                };

                // å¦‚æœæ˜¯ä»£å¸è½¬è´¦ï¼Œæ·»åŠ ä»£å¸åç§°
                if (transferType === 'tokens') {
                    requestBody.tokenName = tokenName;
                }

                // å¦‚æœè®¾ç½®äº†è‡ªå®šä¹‰æ‰‹ç»­è´¹ï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
                if (!isNaN(customFee) && customFee > 0) {
                    requestBody.customFee = customFee;
                }

                const apiEndpoint = transferType === 'tokens' ? '/api/transfer-token' : '/api/transfer';
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();

                if (response.ok) {
                    showResult('success', 'è½¬è´¦æˆåŠŸï¼', {
                        txId: result.transactionId,
                        amount: amount,
                        fee: result.fee,
                        from: fromWallet,
                        to: toAddress.substring(0, 10) + '...'
                    });

                    // æ¸…ç©ºè¡¨å•
                    clearForm();

                    // æ›´æ–°é’±åŒ…åˆ—è¡¨
                    setTimeout(() => {
                        updateWalletList();
                        onWalletChange();
                    }, 1000);

                } else {
                    showResult('error', result.error || 'è½¬è´¦å¤±è´¥');
                }

            } catch (error) {
                console.error('è½¬è´¦å¤±è´¥:', error);
                showResult('error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                // æ¢å¤æŒ‰é’®
                btn.disabled = false;
                btn.textContent = 'å‘é€è½¬è´¦';
            }
        }

        function showResult(type, message, details = null) {
            const resultDiv = document.getElementById('transaction-result');
            const messageDiv = document.getElementById('result-message');
            const detailsDiv = document.getElementById('transaction-details');

            resultDiv.className = `transaction-result ${type}`;
            messageDiv.textContent = message;

            if (details) {
                detailsDiv.innerHTML = `
                    <strong>äº¤æ˜“è¯¦æƒ…:</strong><br>
                    äº¤æ˜“ID: ${details.txId}<br>
                    å‘é€æ–¹: ${details.from}<br>
                    æ¥æ”¶æ–¹: ${details.to}<br>
                    é‡‘é¢: ${details.amount} coins<br>
                    æ‰‹ç»­è´¹: ${details.fee} coins
                `;
            } else {
                detailsDiv.innerHTML = '';
            }

            resultDiv.style.display = 'block';

            // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 5000);
            }
        }

        function clearForm() {
            document.getElementById('from-wallet').value = '';
            document.getElementById('to-address').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('balance-info').style.display = 'none';
            document.getElementById('transaction-result').style.display = 'none';
            selectedWallet = null;
        }
    </script>
</body>
</html>
